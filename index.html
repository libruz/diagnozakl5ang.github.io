<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIAGNOZA Z J. ANGIELSKIEGO KLASA 5b</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #ff6b35;
            --primary-dark: #e55a2b;
            --secondary: #2d3436;
            --light: #f9f9f9;
            --gray: #dfe6e9;
            --visited: #ffeaa7;
            --current: #ff6b35;
            --completed: #00b894;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 25px 0;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .test-container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            min-height: 500px;
            position: relative;
        }
        
        .step {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .step.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--gray);
        }
        
        h3 {
            margin: 15px 0 10px;
            color: var(--secondary);
        }
        
        .question {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }
        
        .option {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: white;
            border: 1px solid var(--gray);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option:hover {
            border-color: var(--primary);
            background-color: #fff9f7;
        }
        
        .option input {
            margin-right: 10px;
            cursor: pointer;
        }
        
        .translation-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray);
            border-radius: 5px;
            font-size: 1rem;
            margin-top: 5px;
        }
        
        .translation-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.2);
        }
        
        .audio-player {
            background-color: #f1f2f6;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .audio-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }
        
        .audio-btn:hover {
            background-color: var(--primary-dark);
        }
        
        .audio-btn:disabled {
            background-color: #b2bec3;
            cursor: not-allowed;
        }
        
        .audio-counter {
            font-weight: bold;
            color: var(--primary);
            background-color: white;
            padding: 5px 12px;
            border-radius: 20px;
            border: 2px solid var(--primary);
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--gray);
        }
        
        .nav-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-btn.prev {
            background-color: var(--gray);
            color: var(--secondary);
        }
        
        .nav-btn.prev:hover {
            background-color: #b2bec3;
        }
        
        .nav-btn.next {
            background-color: var(--primary);
            color: white;
        }
        
        .nav-btn.next:hover {
            background-color: var(--primary-dark);
        }
        
        .nav-btn.save {
            background-color: var(--completed);
            color: white;
        }
        
        .nav-btn.save:hover {
            background-color: #00a085;
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .progress-container {
            margin-top: 20px;
        }
        
        .progress-bar {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .progress-step.visited {
            background-color: var(--visited);
        }
        
        .progress-step.current {
            background-color: var(--current);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.3);
        }
        
        .progress-step.completed {
            background-color: var(--completed);
            color: white;
        }
        
        .progress-step span {
            font-size: 0.8rem;
            position: absolute;
            top: -20px;
            white-space: nowrap;
        }
        
        .progress-info {
            text-align: center;
            color: var(--secondary);
            font-size: 0.9rem;
        }
        
        .name-input {
            width: 100%;
            max-width: 500px;
            padding: 15px;
            font-size: 1.1rem;
            border: 2px solid var(--gray);
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .name-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .student-info {
            background-color: #fff9f7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary);
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .task-instruction {
            font-style: italic;
            color: #636e72;
            margin-bottom: 15px;
        }
        
        .match-question {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid var(--gray);
        }
        
        .match-label {
            min-width: 100px;
            font-weight: bold;
        }
        
        .match-select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid var(--gray);
            background-color: white;
            flex-grow: 1;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #636e72;
            font-size: 0.9rem;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .test-container {
                padding: 20px;
            }
            
            .progress-step {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .nav-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DIAGNOZA Z J. ANGIELSKIEGO</h1>
            <div class="subtitle">Klasa 5b • Test interaktywny</div>
        </header>
        
        <div class="test-container">
            <!-- Krok 0: Imię i nazwisko -->
            <div class="step active" id="step-0">
                <h2>Wprowadzenie</h2>
                <p>Witaj! Przed rozpoczęciem testu prosimy o podanie swoich danych.</p>
                
                <div class="student-info">
                    <h3>Twoje dane</h3>
                    <input type="text" id="student-name" class="name-input" placeholder="Imię i nazwisko" required>
                    <p><small>Po podaniu danych kliknij "Dalej" aby rozpocząć test.</small></p>
                </div>
                
                <div class="task-instruction">
                    <i class="fas fa-info-circle"></i> Test składa się z 13 zadań. Możesz poruszać się między zadaniami za pomocą przycisków "Wstecz" i "Dalej" lub klikając na pasek postępu na dole strony.
                </div>
            </div>
            
            <!-- Kroki 1-13 będą generowane dynamicznie w JavaScript -->
            <div id="steps-container"></div>
            
            <!-- Komunikaty -->
            <div id="message" class="message"></div>
        </div>
        
        <!-- Pasek postępu -->
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar">
                <!-- Kroki będą generowane dynamicznie -->
            </div>
            <div class="progress-info">
                <span id="progress-text">Krok 0 z 13: Wprowadzenie</span>
            </div>
        </div>
        
        <!-- Nawigacja -->
        <div class="navigation">
            <button class="nav-btn prev" id="prev-btn" disabled>
                <i class="fas fa-arrow-left"></i> Wstecz
            </button>
            <button class="nav-btn next" id="next-btn">
                Dalej <i class="fas fa-arrow-right"></i>
            </button>
        </div>
        
        <footer>
            <p>Test opracowany na podstawie materiałów Nowa Era • Odpowiedzi zapisywane są w bazie danych</p>
        </footer>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <script>
        // Konfiguracja Supabase
        const SUPABASE_URL = 'https://pozqjihdisdsyzcelydh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvenFqaWhkaXNkc3l6Y2VseWRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5Mzk0NDgsImV4cCI6MjA4NTUxNTQ0OH0.iLLGaMf89VrtO3RuL4fheOQQDWrSLvbU-p9mr6vhHyU';
        
        // Tworzymy klienta Supabase
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Dane testu - zadania i typy
        const tasks = [
            {
                id: 1,
                title: "Zadanie 1: Rozumienie ze słuchu",
                instruction: "Posłuchaj nagrania i wybierz poprawną odpowiedź.",
                type: "multiple-choice",
                questions: [
                    "1. What day of the week is it?",
                    "2. Sarah cleans:",
                    "3. Sarah's bedroom is:",
                    "4. What is Tony's favourite activity?",
                    "5. Sarah thinks that mopping floors is:"
                ],
                options: [
                    ["A. Friday", "B. Saturday", "C. Sunday"],
                    ["A. one bedroom.", "B. the whole house.", "C. two rooms."],
                    ["A. very small.", "B. big.", "C. new."],
                    ["A. Mopping the floors", "B. Doing the dusting", "C. Washing the dishes"],
                    ["A. fantastic.", "B. boring.", "C. relaxing."]
                ],
                hasAudio: true,
                // Jeśli pliki są w folderze audio/, zmień na: "audio/nagranie1.mp3"
                audioFile: "nagranie1.mp3", 
                audioPlays: 3
            },
            {
                id: 2,
                title: "Zadanie 2: Rozumienie ze słuchu",
                instruction: "Posłuchaj nagrania i zdecyduj czy zdania są prawdziwe (T) czy fałszywe (F).",
                type: "true-false",
                questions: [
                    "1. Monica has tennis classes after school.",
                    "2. Tom always helps his mum.",
                    "3. Steven's pet snake eats something every day.",
                    "4. Mr Taylor doesn't like swimming.",
                    "5. Jacob has got a police officer's hat."
                ],
                hasAudio: true,
                audioFile: "nagranie2.mp3",
                audioPlays: 3
            },
            {
                id: 3,
                title: "Zadanie 3: Rozumienie ze słuchu",
                instruction: "Posłuchaj nagrania i dopasuj mówców (1-5) do pytań (A-E).",
                type: "matching",
                questions: [
                    "Speaker 1",
                    "Speaker 2", 
                    "Speaker 3",
                    "Speaker 4",
                    "Speaker 5"
                ],
                matches: ["A. What do you do on your birthday?", "B. When do you get up?", "C. When do you do your homework?", "D. When do you play computer games?", "E. When do you eat lunch?"],
                hasAudio: true,
                audioFile: "nagranie3.mp3",
                audioPlays: 3
            },
            {
                id: 4,
                title: "Zadanie 4: Czytanie ze zrozumieniem",
                instruction: "Przeczytaj tekst i wybierz poprawną odpowiedź: A, B lub C.",
                type: "multiple-choice",
                questions: [
                    "1. The new sports centre is",
                    "2. Which sport can't you do at the open day?",
                    "3. How many sports can you play with a ball at the open day?",
                    "4. There is a very high at the sports centre.",
                    "5. What can you buy at a special price?"
                ],
                options: [
                    ["A. in a school", "B. next to a football stadium", "C. near a school"],
                    ["A. football", "B. judo", "C. basketball"],
                    ["A. three", "B. two", "C. one"],
                    ["A. trampoline", "B. diving board", "C. swimming pool"],
                    ["A. sports shoes", "B. sports clothes", "C. sports equipment"]
                ]
            },
            {
                id: 5,
                title: "Zadanie 5: Wybór poprawnej odpowiedzi",
                instruction: "Wybierz poprawną odpowiedź: A, B lub C.",
                type: "multiple-choice",
                questions: [
                    "1. I play basketball the afternoon.",
                    "2. We eat lunch noon.",
                    "3. I get up 6 am.",
                    "4. I go horse riding Saturdays.",
                    "5. We eat pasta we eat chocolate cake."
                ],
                options: [
                    ["A. on", "B. in", "C. at"],
                    ["A. to", "B. on", "C. at"],
                    ["A. at", "B. in", "C. up"],
                    ["A. on", "B. at", "C. in"],
                    ["A. after", "B. before", "C. behind"]
                ]
            },
            {
                id: 6,
                title: "Zadanie 6: Wybór poprawnej odpowiedzi",
                instruction: "Wybierz poprawną odpowiedź: A, B lub C.",
                type: "multiple-choice",
                questions: [
                    "1. A looks like a large dog.",
                    "2. A is a small, cute, fluffy animal.",
                    "3. The is a symbol of Poland.",
                    "4. Look in the water! I can see a swimming.",
                    "5. A is a bird of many colours."
                ],
                options: [
                    ["A. seal", "B. wolf", "C. cat"],
                    ["A. rat", "B. pig", "C. guinea pig"],
                    ["A. kangaroo", "B. hamster", "C. eagle"],
                    ["A. seal", "B. spider", "C. parrot"],
                    ["A. parrot", "B. seal", "C. mouse"]
                ]
            },
            {
                id: 7,
                title: "Zadanie 7: Tłumaczenie",
                instruction: "Przetłumacz na język angielski fragmenty zdań podane w nawiasie.",
                type: "translation",
                questions: [
                    "1. This hamster looks (bardzo uroczo)",
                    "2. Did you know that seals can be (niebezpieczne)?",
                    "3. I love looking at pictures of (egzotycznych zwierząt)",
                    "4. Wolves can run at speeds of 65km per hour. They're really (szybkie i silne)",
                    "5. My new dog is really (puszysty)"
                ],
                examples: ["Przykład: Suzy is very (przyjazna) friendly."]
            },
            {
                id: 8,
                title: "Zadanie 8: Tłumaczenie",
                instruction: "Przetłumacz słowa z nawiasów na język angielski.",
                type: "translation",
                questions: [
                    "1. I like team sports like basketball and (siatkówkę)",
                    "2. My parents finish work earlier (w piątki)",
                    "3. Sam thinks (łyżwiarstwo)",
                    "4. We always (odrabiamy pracę domową)",
                    "5. I would like to get a (świnkę morską)",
                    "6. My best friend Tom has got a (domek na drzewie)",
                    "7. My cousin comes from Italy. She's (Włoszką)",
                    "8. Marcus, remember to (opiekować się)",
                    "9. Dad says (jesień)",
                    "10. Do you know that (szpinak)"
                ],
                examples: ["Przykład: I want to (zorganizować) organise a party."]
            },
            {
                id: 9,
                title: "Zadanie 9: Uzupełnianie zdań",
                instruction: "Przeczytaj zdania i wybierz właściwe wyrazy.",
                type: "completion",
                questions: [
                    "1. A: Are you happy? B: Yes, I am / are.",
                    "2. Suzy have got / has got two brothers.",
                    "3. Look! There are three mouse / mice.",
                    "4. A: Do you speak English? B: No, I don't / doesn't.",
                    "5. Do / Does she like dogs?"
                ],
                examples: ["Przykład: My name is / are Ann."]
            },
            {
                id: 10,
                title: "Zadanie 10: Wybór poprawnej odpowiedzi",
                instruction: "Przeczytaj pytania i zakreśl właściwą odpowiedź.",
                type: "multiple-choice",
                questions: [
                    "1. Who's in the photo?",
                    "2. Where is my schoolbag?",
                    "3. What time do you have lunch at school?",
                    "4. When do you go skiing?",
                    "5. How do you go to school?"
                ],
                options: [
                    ["A. She's cute.", "B. It's my cousin.", "C. An old castle."],
                    ["A. It's red.", "B. It's under the chair.", "C. It is my schoolbag."],
                    ["A. In the afternoon.", "B. At one o'clock.", "C. A ham and cheese sandwich."],
                    ["A. In the mountains.", "B. I like skiing.", "C. During the winter holidays."],
                    ["A. By bike.", "B. Twenty.", "C. It's next to my house."]
                ]
            },
            {
                id: 11,
                title: "Zadanie 11: Dopasowywanie",
                instruction: "Dopasuj pytania (1-5) do odpowiedzi (A-E).",
                type: "matching",
                questions: [
                    "1. What does it do?",
                    "2. What does it look like?",
                    "3. What does it usually eat?",
                    "4. How often do you feed it?",
                    "5. Where does your tortoise live?"
                ],
                matches: ["A. It likes lettuce.", "B. It lives in my garden.", "C. Two times every day.", "D. It walks slowly and sleeps a lot.", "E. It's brown and green and very small."]
            },
            {
                id: 12,
                title: "Zadanie 12: Tłumaczenie",
                instruction: "Przetłumacz fragmenty rozmów w nawiasach na język angielski.",
                type: "translation",
                questions: [
                    "1. A: It's my (urodziny) today. B: All the best!",
                    "2. A: I'm not allowed to play computer games at home. B: Oh, that's (straszne)",
                    "3. A: Sorry, but I can't come to your birthday party. B: (Jaka szkoda)",
                    "4. A: Here's a present (dla Ciebie) B: What a nice (niespodzianka)",
                    "5. A: You can visit me on Sunday. B: Fantastic, that's good (wiadomość)"
                ],
                examples: ["Przykład: I want to (zorganizować) organise a party."]
            },
            {
                id: 13,
                title: "Zadanie 13: Dopasowywanie",
                instruction: "Dopasuj zdania (1-5) do odpowiedzi (A-E).",
                type: "matching",
                questions: [
                    "1. Enjoy your meal!",
                    "2. Dad, what's for dinner?",
                    "3. What would you like to eat?",
                    "4. Can I have a lemonade, please?",
                    "5. Thank you for making a really tasty lunch."
                ],
                matches: ["A. We've got sausage and potatoes tonight.", "B. You're welcome. I'm happy you like it.", "C. I would like to have a chicken salad.", "D. Thank you. It looks really tasty.", "E. Yes, here you are."]
            }
        ];
        
        // Stan aplikacji
        let currentStep = 0;
        let studentName = "";
        let studentAnswers = {};
        let audioPlayCounts = {1: 0, 2: 0, 3: 0};
        
        // Inicjalizacja aplikacji
        document.addEventListener('DOMContentLoaded', function() {
            initTest();
            renderProgressBar();
            updateNavigation();
            
            // Event listeners dla przycisków nawigacji
            document.getElementById('prev-btn').addEventListener('click', prevStep);
            document.getElementById('next-btn').addEventListener('click', nextStep);
            
            // Event listener dla pola imienia i nazwiska
            document.getElementById('student-name').addEventListener('input', function(e) {
                studentName = e.target.value.trim();
                document.getElementById('next-btn').disabled = !studentName;
            });
        });
        
        // Inicjalizacja testu - generowanie kroków
        function initTest() {
            const container = document.getElementById('steps-container');
            
            tasks.forEach(task => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'step';
                stepDiv.id = `step-${task.id}`;
                
                let content = `<h2>${task.title}</h2>`;
                content += `<p class="task-instruction">${task.instruction}</p>`;
                
                // Przykłady jeśli istnieją
                if (task.examples) {
                    task.examples.forEach(example => {
                        content += `<p><strong>${example}</strong></p>`;
                    });
                }
                
                // Odtwarzacz audio dla zadań z nagraniem
                if (task.hasAudio) {
                    content += `
                    <div class="audio-player">
                        <div>
                            <strong>Nagranie do zadania:</strong>
                            <p>Kliknij poniższy przycisk aby odsłuchać nagranie. Możesz odsłuchać je maksymalnie 3 razy.</p>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="audio-counter" id="audio-counter-${task.id}">Pozostało odsłuchań: ${task.audioPlays}</div>
                            <button class="audio-btn" id="audio-btn-${task.id}" data-audio="${task.audioFile}" data-task="${task.id}">
                                <i class="fas fa-play"></i> Odsłuchaj nagranie
                            </button>
                        </div>
                    </div>
                    `;
                }
                
                // Pytania w zależności od typu zadania
                if (task.type === 'multiple-choice') {
                    task.questions.forEach((question, index) => {
                        content += `
                        <div class="question">
                            <h3>${question}</h3>
                            <div class="options">
                                ${task.options[index].map(option => `
                                <label class="option">
                                    <input type="radio" name="task-${task.id}-q${index+1}" value="${option.charAt(0)}">
                                    ${option}
                                </label>
                                `).join('')}
                            </div>
                        </div>
                        `;
                    });
                }
                else if (task.type === 'true-false') {
                    task.questions.forEach((question, index) => {
                        content += `
                        <div class="question">
                            <h3>${question}</h3>
                            <div class="options">
                                <label class="option">
                                    <input type="radio" name="task-${task.id}-q${index+1}" value="T">
                                    Prawda (T)
                                </label>
                                <label class="option">
                                    <input type="radio" name="task-${task.id}-q${index+1}" value="F">
                                    Fałsz (F)
                                </label>
                            </div>
                        </div>
                        `;
                    });
                }
                else if (task.type === 'matching') {
                    task.questions.forEach((question, index) => {
                        content += `
                        <div class="match-question">
                            <div class="match-label">${question}</div>
                            <select class="match-select" name="task-${task.id}-q${index+1}">
                                <option value="">-- Wybierz --</option>
                                ${task.matches.map((match, matchIndex) => `
                                <option value="${String.fromCharCode(65 + matchIndex)}">${match}</option>
                                `).join('')}
                            </select>
                        </div>
                        `;
                    });
                }
                else if (task.type === 'translation' || task.type === 'completion') {
                    task.questions.forEach((question, index) => {
                        content += `
                        <div class="question">
                            <h3>${question}</h3>
                            <input type="text" class="translation-input" name="task-${task.id}-q${index+1}" placeholder="Wpisz tłumaczenie...">
                        </div>
                        `;
                    });
                }
                
                stepDiv.innerHTML = content;
                container.appendChild(stepDiv);
            });
            
            // Dodaj event listenery dla przycisków audio
            tasks.filter(task => task.hasAudio).forEach(task => {
                const btn = document.getElementById(`audio-btn-${task.id}`);
                if (btn) {
                    btn.addEventListener('click', function() {
                        playAudio(this.dataset.audio, task.id);
                    });
                }
            });
        }
        
        // Odtwarzanie audio
        function playAudio(audioFile, taskId) {
            const btn = document.getElementById(`audio-btn-${taskId}`);
            const counter = document.getElementById(`audio-counter-${taskId}`);
            const task = tasks.find(t => t.id === taskId);
            
            if (audioPlayCounts[taskId] >= task.audioPlays) {
                showMessage("Przekroczono limit odsłuchań dla tego nagrania.", "error");
                btn.disabled = true;
                return;
            }
            
            // Zwiększ licznik odtworzeń
            audioPlayCounts[taskId]++;
            const remaining = task.audioPlays - audioPlayCounts[taskId];
            counter.textContent = `Pozostało odsłuchań: ${remaining}`;
            
            if (remaining <= 0) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-ban"></i> Limit wykorzystany';
            }
            
            // Rzeczywiste odtwarzanie audio
            try {
                // Jeśli pliki są w folderze audio/, odkomentuj poniższą linię:
                // const audioPath = `audio/${audioFile}`;
                const audioPath = audioFile;
                const audio = new Audio(audioPath);
                
                // Zmień ikonę przycisku podczas odtwarzania
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-pause"></i> Odtwarzanie...';
                btn.disabled = true;
                
                audio.play().then(() => {
                    showMessage(`Odtwarzanie nagrania... (${audioPlayCounts[taskId]}/${task.audioPlays})`, "success");
                    
                    // Przywróć przycisk po zakończeniu odtwarzania
                    audio.onended = function() {
                        btn.innerHTML = '<i class="fas fa-play"></i> Odsłuchaj nagranie';
                        btn.disabled = false;
                    };
                    
                }).catch(error => {
                    console.error("Błąd odtwarzania audio:", error);
                    showMessage("Nie udało się odtworzyć nagrania. Sprawdź czy plik istnieje.", "error");
                    btn.innerHTML = '<i class="fas fa-play"></i> Odsłuchaj nagranie';
                    btn.disabled = false;
                    
                    // Cofnij licznik jeśli błąd
                    audioPlayCounts[taskId]--;
                    const newRemaining = task.audioPlays - audioPlayCounts[taskId];
                    counter.textContent = `Pozostało odsłuchań: ${newRemaining}`;
                    
                    if (newRemaining > 0) {
                        btn.disabled = false;
                    }
                });
                
            } catch (error) {
                console.error("Błąd tworzenia obiektu audio:", error);
                showMessage("Błąd odtwarzania. Sprawdź konsolę.", "error");
                btn.disabled = false;
            }
        }
        
        // Renderowanie paska postępu
        function renderProgressBar() {
            const progressBar = document.getElementById('progress-bar');
            progressBar.innerHTML = '';
            
            // Krok 0 - wprowadzenie
            const step0 = document.createElement('div');
            step0.className = `progress-step ${currentStep === 0 ? 'current' : 'visited'}`;
            step0.textContent = '0';
            step0.innerHTML += '<span>Wprowadzenie</span>';
            step0.addEventListener('click', () => goToStep(0));
            progressBar.appendChild(step0);
            
            // Kroki 1-13
            tasks.forEach(task => {
                const step = document.createElement('div');
                const isCurrent = currentStep === task.id;
                const isCompleted = studentAnswers[`task-${task.id}`];
                
                step.className = 'progress-step';
                if (isCurrent) step.classList.add('current');
                else if (isCompleted) step.classList.add('completed');
                else if (currentStep > 0 && task.id < currentStep) step.classList.add('visited');
                
                step.textContent = task.id;
                step.innerHTML += `<span>Zad. ${task.id}</span>`;
                step.addEventListener('click', () => goToStep(task.id));
                progressBar.appendChild(step);
            });
            
            // Aktualizuj tekst postępu
            const progressText = document.getElementById('progress-text');
            if (currentStep === 0) {
                progressText.textContent = "Krok 0 z 13: Wprowadzenie";
            } else {
                progressText.textContent = `Krok ${currentStep} z 13: Zadanie ${currentStep}`;
            }
        }
        
        // Przechodzenie do konkretnego kroku
        function goToStep(step) {
            // Zapisz odpowiedzi z obecnego kroku
            saveCurrentStepAnswers();
            
            // Ukryj obecny krok
            document.querySelector('.step.active').classList.remove('active');
            
            // Pokaż nowy krok
            currentStep = step;
            document.getElementById(`step-${step}`).classList.add('active');
            
            // Załaduj zapisane odpowiedzi dla tego kroku
            loadStepAnswers(step);
            
            // Aktualizuj nawigację i pasek postępu
            updateNavigation();
            renderProgressBar();
        }
        
        // Poprzedni krok
        function prevStep() {
            if (currentStep > 0) {
                // Jeśli jesteśmy na kroku 1, cofamy się do 0
                const prev = currentStep === 1 ? 0 : currentStep - 1;
                goToStep(prev);
            }
        }
        
        // Następny krok
        function nextStep() {
            // Zapisz odpowiedzi z obecnego kroku
            saveCurrentStepAnswers();
            
            // Jeśli to krok 0 (wprowadzenie), przejdź do zadania 1
            if (currentStep === 0) {
                if (!studentName) {
                    showMessage("Proszę podać imię i nazwisko przed rozpoczęciem testu.", "error");
                    return;
                }
                goToStep(1);
            }
            // Jeśli to ostatni krok, zapisz wyniki
            else if (currentStep === 13) {
                saveResults();
            }
            // W przeciwnym razie przejdź do następnego zadania
            else {
                goToStep(currentStep + 1);
            }
        }
        
        // Zapisz odpowiedzi z obecnego kroku
        function saveCurrentStepAnswers() {
            if (currentStep === 0) return;
            
            const stepElement = document.getElementById(`step-${currentStep}`);
            const task = tasks.find(t => t.id === currentStep);
            
            if (!task) return;
            
            const answers = {};
            
            if (task.type === 'multiple-choice' || task.type === 'true-false') {
                for (let i = 1; i <= task.questions.length; i++) {
                    const input = stepElement.querySelector(`input[name="task-${task.id}-q${i}"]:checked`);
                    if (input) {
                        answers[`q${i}`] = input.value;
                    }
                }
            }
            else if (task.type === 'matching') {
                for (let i = 1; i <= task.questions.length; i++) {
                    const select = stepElement.querySelector(`select[name="task-${task.id}-q${i}"]`);
                    if (select && select.value) {
                        answers[`q${i}`] = select.value;
                    }
                }
            }
            else if (task.type === 'translation' || task.type === 'completion') {
                for (let i = 1; i <= task.questions.length; i++) {
                    const input = stepElement.querySelector(`input[name="task-${task.id}-q${i}"]`);
                    if (input && input.value.trim()) {
                        answers[`q${i}`] = input.value.trim();
                    }
                }
            }
            
            // Zapisz odpowiedzi tylko jeśli jakieś istnieją
            if (Object.keys(answers).length > 0) {
                studentAnswers[`task-${task.id}`] = answers;
            }
        }
        
        // Załaduj zapisane odpowiedzi dla kroku
        function loadStepAnswers(step) {
            if (step === 0) return;
            
            const stepElement = document.getElementById(`step-${step}`);
            const task = tasks.find(t => t.id === step);
            const savedAnswers = studentAnswers[`task-${task.id}`];
            
            if (!savedAnswers) return;
            
            if (task.type === 'multiple-choice' || task.type === 'true-false') {
                for (let i = 1; i <= task.questions.length; i++) {
                    const answer = savedAnswers[`q${i}`];
                    if (answer) {
                        const input = stepElement.querySelector(`input[name="task-${task.id}-q${i}"][value="${answer}"]`);
                        if (input) input.checked = true;
                    }
                }
            }
            else if (task.type === 'matching') {
                for (let i = 1; i <= task.questions.length; i++) {
                    const answer = savedAnswers[`q${i}`];
                    if (answer) {
                        const select = stepElement.querySelector(`select[name="task-${task.id}-q${i}"]`);
                        if (select) select.value = answer;
                    }
                }
            }
            else if (task.type === 'translation' || task.type === 'completion') {
                for (let i = 1; i <= task.questions.length; i++) {
                    const answer = savedAnswers[`q${i}`];
                    if (answer) {
                        const input = stepElement.querySelector(`input[name="task-${task.id}-q${i}"]`);
                        if (input) input.value = answer;
                    }
                }
            }
        }
        
        // Aktualizuj przyciski nawigacji
        function updateNavigation() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            // Przycisk Wstecz
            prevBtn.disabled = currentStep === 0;
            
            // Przycisk Dalej/Zapisz
            if (currentStep === 0) {
                nextBtn.textContent = "Dalej";
                nextBtn.className = "nav-btn next";
                nextBtn.disabled = !studentName;
            } else if (currentStep === 13) {
                nextBtn.textContent = "Zapisz odpowiedzi";
                nextBtn.className = "nav-btn save";
                nextBtn.innerHTML = '<i class="fas fa-save"></i> Zapisz odpowiedzi';
                nextBtn.disabled = false;
            } else {
                nextBtn.textContent = "Dalej";
                nextBtn.className = "nav-btn next";
                nextBtn.innerHTML = 'Dalej <i class="fas fa-arrow-right"></i>';
                nextBtn.disabled = false;
            }
        }
        
        // Zapisz wyniki do Supabase
        async function saveResults() {
            showMessage("Zapisywanie wyników...", "success");
            
            // Przygotuj dane do zapisania
            const dataToSave = {
                student_name: studentName,
                answers: studentAnswers,
                audio_plays: audioPlayCounts,
                completed_at: new Date().toISOString()
            };
            
            try {
                const { data, error } = await supabaseClient
                    .from('test_results')
                    .insert([dataToSave]);
                
                if (error) {
                    console.error("Błąd Supabase:", error);
                    throw error;
                }
                
                showMessage("Twoje odpowiedzi zostały pomyślnie zapisane! Dziękujemy za wypełnienie testu.", "success");
                
                // Zablokuj przyciski po zapisaniu
                document.getElementById('prev-btn').disabled = true;
                document.getElementById('next-btn').disabled = true;
                document.getElementById('next-btn').innerHTML = '<i class="fas fa-check"></i> Zapisano!';
                
            } catch (error) {
                console.error("Błąd zapisu do Supabase:", error);
                showMessage("Wystąpił błąd podczas zapisywania wyników. Spróbuj ponownie.", "error");
            }
        }
        
        // Wyświetlanie komunikatów
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
